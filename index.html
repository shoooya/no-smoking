<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>禁煙サポート - あなたの健康と未来のために</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .setup-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .setup-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            margin-top: 10px;
        }

        #shareBtn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            margin-bottom: 10px;
        }

        #shareBtn:hover {
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
        }

        .dashboard {
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            color: #888;
            font-size: 0.9em;
        }

        .milestones-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .milestones-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .milestone {
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 15px;
            border-left: 5px solid #e0e0e0;
            background: #f8f9fa;
            transition: all 0.3s;
            position: relative;
        }

        .milestone.achieved {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            border-left-color: #28a745;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.2);
        }

        .milestone.next {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fff9e6 0%, #ffe8a1 100%);
        }

        .milestone.upcoming {
            border-left-color: #ccc;
            background: #ffffff;
            opacity: 0.9;
        }

        .milestone-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .milestone.achieved .milestone-status {
            background: #28a745;
            color: white;
        }

        .milestone.next .milestone-status {
            background: #ffc107;
            color: #333;
        }

        .milestone.upcoming .milestone-status {
            background: #e0e0e0;
            color: #666;
        }

        .milestone-time {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .milestone-benefit {
            color: #555;
            line-height: 1.6;
        }

        .milestone-remaining {
            margin-top: 8px;
            color: #888;
            font-size: 0.9em;
            font-style: italic;
        }

        .milestone-icon {
            float: right;
            font-size: 1.5em;
        }

        .achievements-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .achievements-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .badge {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            background: #f8f9fa;
            opacity: 0.4;
            transition: all 0.3s;
        }

        .badge.earned {
            opacity: 1;
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            transform: scale(1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .badge-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .badge-name {
            font-weight: 600;
            font-size: 0.9em;
        }

        .progress-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .progress-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .progress-item {
            margin-bottom: 25px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .motivation-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }

        .motivation-card h3 {
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .motivation-card p {
            font-size: 1.1em;
            line-height: 1.6;
            opacity: 0.95;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .badges-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        .timer-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .timer-display h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .timer-value {
            font-size: 3em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .timer-segments {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
        }

        .timer-segment {
            text-align: center;
        }

        .timer-segment-value {
            font-size: 2.5em;
            font-weight: bold;
            display: block;
        }

        .timer-segment-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* 禁煙継続カレンダー（GitHub風ヒートマップ） */
        .calendar-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .calendar-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .calendar-heatmap {
            display: flex;
            gap: 3px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .calendar-week {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .calendar-day {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            background: #ebedf0;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .calendar-day.future {
            background: #f8f9fa;
            border: 1px dashed #e0e0e0;
        }

        .calendar-day.success-light {
            background: #84fab0;
        }

        .calendar-day.success-perfect {
            background: #28a745;
        }

        .calendar-day.has-craving {
            background: #ffc107;
        }

        .calendar-day.slip {
            background: #dc3545;
        }

        .calendar-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            white-space: nowrap;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        .calendar-legend {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            font-size: 0.85em;
            color: #666;
        }

        .calendar-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .calendar-legend-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            .calendar-day {
                width: 12px;
                height: 12px;
            }

            .calendar-heatmap {
                gap: 2px;
            }

            .calendar-week {
                gap: 2px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🚭 禁煙サポート</h1>
            <p>あなたの健康と未来のために</p>
        </header>

        <!-- セットアップ画面 -->
        <div id="setup" class="setup-card">
            <h2>禁煙を始めましょう！</h2>
            <form id="setupForm">
                <div class="form-group">
                    <label for="quitDate">禁煙開始日時</label>
                    <input type="datetime-local" id="quitDate" required>
                </div>
                <div class="form-group">
                    <label for="cigarettesPerDay">1日あたりの喫煙本数</label>
                    <input type="number" id="cigarettesPerDay" min="1" value="20" required>
                </div>
                <div class="form-group">
                    <label for="pricePerPack">1箱の価格（円）</label>
                    <input type="number" id="pricePerPack" min="1" value="600" required>
                </div>
                <div class="form-group">
                    <label for="cigarettesPerPack">1箱あたりの本数</label>
                    <input type="number" id="cigarettesPerPack" min="1" value="20" required>
                </div>
                <button type="submit" class="btn">禁煙を開始する</button>
            </form>
        </div>

        <!-- ダッシュボード -->
        <div id="dashboard" class="dashboard">
            <!-- タイマー表示 -->
            <div class="timer-display">
                <h2>禁煙継続時間</h2>
                <div class="timer-segments">
                    <div class="timer-segment">
                        <span class="timer-segment-value" id="days">0</span>
                        <span class="timer-segment-label">日</span>
                    </div>
                    <div class="timer-segment">
                        <span class="timer-segment-value" id="hours">0</span>
                        <span class="timer-segment-label">時間</span>
                    </div>
                    <div class="timer-segment">
                        <span class="timer-segment-value" id="minutes">0</span>
                        <span class="timer-segment-label">分</span>
                    </div>
                    <div class="timer-segment">
                        <span class="timer-segment-value" id="seconds">0</span>
                        <span class="timer-segment-label">秒</span>
                    </div>
                </div>
            </div>

            <!-- 禁煙継続カレンダー -->
            <div class="calendar-card">
                <h2>禁煙継続カレンダー</h2>
                <div id="calendarHeatmap" class="calendar-heatmap"></div>
                <div class="calendar-legend">
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-box" style="background: #f8f9fa; border: 1px dashed #e0e0e0;"></div>
                        <span>未到達</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-box" style="background: #84fab0;"></div>
                        <span>継続中</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-box" style="background: #28a745;"></div>
                        <span>完璧な1日</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-box" style="background: #ffc107;"></div>
                        <span>渇望あり</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-box" style="background: #dc3545;"></div>
                        <span>スリップ</span>
                    </div>
                </div>
            </div>
            <div class="calendar-tooltip" id="calendarTooltip"></div>

            <!-- 統計カード -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">💰</div>
                    <div class="stat-value" id="moneySaved">¥0</div>
                    <div class="stat-label">節約した金額</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🚬</div>
                    <div class="stat-value" id="cigarettesAvoided">0</div>
                    <div class="stat-label">吸わなかったタバコ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⏱️</div>
                    <div class="stat-value" id="lifeRegained">0</div>
                    <div class="stat-label">取り戻した時間（分）</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">❤️</div>
                    <div class="stat-value" id="healthScore">0%</div>
                    <div class="stat-label">健康回復度</div>
                </div>
            </div>

            <!-- モチベーションメッセージ -->
            <div class="motivation-card">
                <h3>今日のメッセージ</h3>
                <p id="motivationText">素晴らしい！禁煙を続けています。一日一日があなたの勝利です！</p>
            </div>

            <!-- 健康マイルストーン -->
            <div class="milestones-card">
                <h2>健康マイルストーン</h2>
                <div id="milestones"></div>
            </div>

            <!-- 進捗状況 -->
            <div class="progress-card">
                <h2>目標までの進捗</h2>
                <div class="progress-item">
                    <div class="progress-label">
                        <span>1週間達成</span>
                        <span id="week1Progress">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="week1Bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="progress-item">
                    <div class="progress-label">
                        <span>1ヶ月達成</span>
                        <span id="month1Progress">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="month1Bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="progress-item">
                    <div class="progress-label">
                        <span>1年達成</span>
                        <span id="year1Progress">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="year1Bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- 達成バッジ -->
            <div class="achievements-card">
                <h2>達成バッジ</h2>
                <div class="badges-grid" id="badges"></div>
            </div>

            <button class="btn" id="shareBtn">🔗 進捗を共有するURLをコピー</button>
            <button class="btn btn-secondary" id="resetBtn">データをリセット</button>
        </div>
    </div>

    <script>
        // グローバル変数
        let quitData = null;
        let updateInterval = null;
        let calendarData = {};

        // 健康マイルストーン（医学的根拠に基づく）
        const healthMilestones = [
            { minutes: 20, text: '血圧と脈拍が正常値に戻り始めます', icon: '❤️' },
            { minutes: 480, text: '血中の一酸化炭素濃度が正常値に戻ります', icon: '🫁' },
            { minutes: 1440, text: '心臓発作のリスクが減少し始めます', icon: '💓' },
            { minutes: 2880, text: '味覚と嗅覚が回復し始めます', icon: '👃' },
            { minutes: 10080, text: '肺機能が改善し、呼吸が楽になります', icon: '🌬️' },
            { minutes: 43200, text: '循環器系が大幅に改善されます', icon: '🩸' },
            { minutes: 129600, text: '肺がきれいになり、感染症のリスクが低下します', icon: '✨' },
            { minutes: 525600, text: '心臓病のリスクが半減します', icon: '💪' },
            { minutes: 2628000, text: '肺がん等のリスクが大幅に低下します', icon: '🎯' },
            { minutes: 7884000, text: '健康状態がほぼ非喫煙者レベルに！', icon: '🏆' }
        ];

        // 達成バッジ
        const achievements = [
            { id: 'first-hour', minutes: 60, name: '最初の1時間', icon: '⭐' },
            { id: 'first-day', minutes: 1440, name: '1日達成', icon: '🌟' },
            { id: 'three-days', minutes: 4320, name: '3日達成', icon: '✨' },
            { id: 'one-week', minutes: 10080, name: '1週間達成', icon: '🎖️' },
            { id: 'two-weeks', minutes: 20160, name: '2週間達成', icon: '🏅' },
            { id: 'one-month', minutes: 43200, name: '1ヶ月達成', icon: '🥇' },
            { id: 'three-months', minutes: 129600, name: '3ヶ月達成', icon: '👑' },
            { id: 'six-months', minutes: 259200, name: '6ヶ月達成', icon: '💎' },
            { id: 'one-year', minutes: 525600, name: '1年達成', icon: '🏆' },
            { id: 'money-saver', condition: 'money', threshold: 10000, name: '節約1万円', icon: '💰' },
            { id: 'big-saver', condition: 'money', threshold: 50000, name: '節約5万円', icon: '💵' },
            { id: 'mega-saver', condition: 'money', threshold: 100000, name: '節約10万円', icon: '💴' }
        ];

        // モチベーションメッセージ
        const motivationMessages = [
            '素晴らしい！あなたは健康への第一歩を踏み出しました。',
            '一本吸わない度に、あなたの体は回復しています。',
            '禁煙は最高の自己投資です。続けましょう！',
            'あなたの意志の強さは素晴らしいです。',
            '毎日が新しい勝利です。誇りに思ってください！',
            'タバコなしの人生は、より明るく健康的です。',
            'あなたは自分の健康をコントロールしています。',
            '禁煙の道のりは簡単ではありませんが、あなたならできます！',
            '今日も禁煙を続けることができました。素晴らしい！',
            'あなたの努力は、必ず報われます。頑張りましょう！'
        ];

        // ページ読み込み時の処理
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();

            // 現在時刻をデフォルト値として設定
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('quitDate').value = now.toISOString().slice(0, 16);
        });

        // URLクエリパラメータから禁煙データを読み取る
        function loadDataFromURL() {
            const params = new URLSearchParams(window.location.search);

            if (params.has('quitDate') && params.has('cigarettesPerDay') &&
                params.has('pricePerPack') && params.has('cigarettesPerPack')) {

                const cigarettesPerDay = parseInt(params.get('cigarettesPerDay'));
                const pricePerPack = parseInt(params.get('pricePerPack'));
                const cigarettesPerPack = parseInt(params.get('cigarettesPerPack'));

                return {
                    quitDate: params.get('quitDate'),
                    cigarettesPerDay,
                    pricePerPack,
                    cigarettesPerPack,
                    pricePerCigarette: pricePerPack / cigarettesPerPack
                };
            }

            return null;
        }

        // 共有用URLを生成
        function generateShareURL() {
            if (!quitData) return null;

            const baseURL = window.location.origin + window.location.pathname;
            const params = new URLSearchParams({
                quitDate: quitData.quitDate,
                cigarettesPerDay: quitData.cigarettesPerDay,
                pricePerPack: quitData.pricePerPack,
                cigarettesPerPack: quitData.cigarettesPerPack
            });

            return `${baseURL}?${params.toString()}`;
        }

        // 共有URLをコピー
        function copyShareURL() {
            const shareURL = generateShareURL();
            if (!shareURL) return;

            navigator.clipboard.writeText(shareURL).then(() => {
                const btn = document.getElementById('shareBtn');
                const originalText = btn.textContent;
                btn.textContent = '✓ URLをコピーしました！';
                btn.style.background = 'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)';

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(err => {
                alert('URLのコピーに失敗しました: ' + err);
            });
        }

        // イベントリスナーの設定
        function setupEventListeners() {
            document.getElementById('setupForm').addEventListener('submit', handleSetup);
            document.getElementById('resetBtn').addEventListener('click', handleReset);
            document.getElementById('shareBtn').addEventListener('click', copyShareURL);
        }

        // セットアップフォームの処理
        function handleSetup(e) {
            e.preventDefault();

            const quitDate = new Date(document.getElementById('quitDate').value);
            const cigarettesPerDay = parseInt(document.getElementById('cigarettesPerDay').value);
            const pricePerPack = parseInt(document.getElementById('pricePerPack').value);
            const cigarettesPerPack = parseInt(document.getElementById('cigarettesPerPack').value);

            quitData = {
                quitDate: quitDate.toISOString(),
                cigarettesPerDay,
                pricePerPack,
                cigarettesPerPack,
                pricePerCigarette: pricePerPack / cigarettesPerPack
            };

            saveData();
            showDashboard();
            startUpdating();
        }

        // リセット処理
        function handleReset() {
            if (confirm('本当にデータをリセットしますか？これまでの記録は全て削除されます。')) {
                localStorage.removeItem('quitData');
                quitData = null;
                if (updateInterval) {
                    clearInterval(updateInterval);
                }
                showSetup();
            }
        }

        // データの保存
        function saveData() {
            localStorage.setItem('quitData', JSON.stringify(quitData));
            localStorage.setItem('calendarData', JSON.stringify(calendarData));
        }

        // データの読み込み
        function loadData() {
            // カレンダーデータの読み込み
            const savedCalendar = localStorage.getItem('calendarData');
            if (savedCalendar) {
                calendarData = JSON.parse(savedCalendar);
            }

            // まずURLクエリパラメータをチェック
            const urlData = loadDataFromURL();
            if (urlData) {
                quitData = urlData;
                // URLから読み込んだデータもローカルストレージに保存
                saveData();
                showDashboard();
                startUpdating();
                return;
            }

            // URLにデータがない場合、ローカルストレージをチェック
            const saved = localStorage.getItem('quitData');
            if (saved) {
                quitData = JSON.parse(saved);
                showDashboard();
                startUpdating();
            } else {
                showSetup();
            }
        }

        // セットアップ画面を表示
        function showSetup() {
            document.getElementById('setup').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('dashboard').style.display = 'none';
        }

        // ダッシュボードを表示
        function showDashboard() {
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('setup').style.display = 'none';
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('dashboard').style.display = 'block';
        }

        // 定期更新の開始
        function startUpdating() {
            initTodayCalendarData();
            updateDashboard();
            updateInterval = setInterval(updateDashboard, 1000);
        }

        // ダッシュボードの更新
        function updateDashboard() {
            const now = new Date();
            const quitDate = new Date(quitData.quitDate);
            const diffMs = now - quitDate;

            if (diffMs < 0) {
                return; // 未来の日付が設定されている場合
            }

            const diffMinutes = Math.floor(diffMs / 60000);
            const diffSeconds = Math.floor(diffMs / 1000);

            // 時間の計算
            const days = Math.floor(diffMinutes / 1440);
            const hours = Math.floor((diffMinutes % 1440) / 60);
            const minutes = diffMinutes % 60;
            const seconds = diffSeconds % 60;

            // タイマー表示の更新
            document.getElementById('days').textContent = days;
            document.getElementById('hours').textContent = hours;
            document.getElementById('minutes').textContent = minutes;
            document.getElementById('seconds').textContent = seconds;

            // 統計の計算
            const cigarettesAvoided = Math.floor((diffMinutes / 1440) * quitData.cigarettesPerDay);
            const moneySaved = Math.floor(cigarettesAvoided * quitData.pricePerCigarette);
            const lifeRegained = cigarettesAvoided * 11; // 1本あたり11分寿命が縮むとされる

            // 健康スコアの計算（15年で100%）
            const healthScore = Math.min(100, Math.floor((diffMinutes / 7884000) * 100));

            // 統計の表示
            document.getElementById('moneySaved').textContent = `¥${moneySaved.toLocaleString()}`;
            document.getElementById('cigarettesAvoided').textContent = cigarettesAvoided.toLocaleString();
            document.getElementById('lifeRegained').textContent = lifeRegained.toLocaleString();
            document.getElementById('healthScore').textContent = `${healthScore}%`;

            // マイルストーンの更新
            updateMilestones(diffMinutes);

            // バッジの更新
            updateBadges(diffMinutes, moneySaved);

            // 進捗バーの更新
            updateProgress(diffMinutes);

            // モチベーションメッセージの更新（1日ごとに変更）
            const messageIndex = days % motivationMessages.length;
            document.getElementById('motivationText').textContent = motivationMessages[messageIndex];

            // カレンダーヒートマップの更新
            updateCalendarHeatmap();
        }

        // カレンダーヒートマップの生成と更新
        function updateCalendarHeatmap() {
            const container = document.getElementById('calendarHeatmap');
            container.innerHTML = '';

            const today = new Date();
            const quitDate = new Date(quitData.quitDate);

            // 52週間分のカレンダーを生成
            const weeks = 52;
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - (weeks * 7));

            for (let week = 0; week < weeks; week++) {
                const weekDiv = document.createElement('div');
                weekDiv.className = 'calendar-week';

                for (let day = 0; day < 7; day++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + (week * 7) + day);

                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';

                    const dateStr = formatDateStr(currentDate);
                    dayDiv.dataset.date = dateStr;

                    // 日付の状態を判定
                    if (currentDate > today) {
                        // 未来の日付
                        dayDiv.classList.add('future');
                    } else if (currentDate < quitDate) {
                        // 禁煙開始前の日付
                        dayDiv.classList.add('future');
                    } else {
                        // 禁煙開始後の日付
                        const dayData = calendarData[dateStr];
                        if (dayData) {
                            if (dayData.status === 'slip') {
                                dayDiv.classList.add('slip');
                            } else if (dayData.cravingCount > 0) {
                                dayDiv.classList.add('has-craving');
                            } else {
                                dayDiv.classList.add('success-perfect');
                            }
                        } else {
                            // データがない場合は継続中として扱う
                            dayDiv.classList.add('success-light');
                        }
                    }

                    // ホバー時のツールチップ
                    dayDiv.addEventListener('mouseenter', function(e) {
                        showCalendarTooltip(e, currentDate, dateStr);
                    });

                    dayDiv.addEventListener('mouseleave', function() {
                        hideCalendarTooltip();
                    });

                    weekDiv.appendChild(dayDiv);
                }

                container.appendChild(weekDiv);
            }
        }

        // 日付を文字列にフォーマット（YYYY-MM-DD）
        function formatDateStr(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // カレンダーツールチップの表示
        function showCalendarTooltip(event, date, dateStr) {
            const tooltip = document.getElementById('calendarTooltip');
            const dayData = calendarData[dateStr];
            const today = new Date();
            const quitDate = new Date(quitData.quitDate);

            let content = '';

            if (date > today) {
                content = `${dateStr}<br>未到達`;
            } else if (date < quitDate) {
                content = `${dateStr}<br>禁煙開始前`;
            } else {
                const daysDiff = Math.floor((date - quitDate) / (1000 * 60 * 60 * 24)) + 1;
                content = `${dateStr}<br>禁煙${daysDiff}日目`;

                if (dayData) {
                    if (dayData.status === 'slip') {
                        content += '<br>❌ スリップ';
                    } else if (dayData.cravingCount > 0) {
                        content += `<br>⚠️ 渇望${dayData.cravingCount}回`;
                    } else {
                        content += '<br>✓ 完璧な1日';
                    }
                    if (dayData.notes) {
                        content += `<br>${dayData.notes}`;
                    }
                } else {
                    content += '<br>✓ 禁煙継続中';
                }
            }

            tooltip.innerHTML = content;
            tooltip.style.display = 'block';

            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = (rect.left + window.scrollX) + 'px';
            tooltip.style.top = (rect.bottom + window.scrollY + 5) + 'px';
        }

        // カレンダーツールチップの非表示
        function hideCalendarTooltip() {
            const tooltip = document.getElementById('calendarTooltip');
            tooltip.style.display = 'none';
        }

        // 今日のカレンダーデータを初期化（まだ存在しない場合）
        function initTodayCalendarData() {
            const today = formatDateStr(new Date());
            if (!calendarData[today]) {
                calendarData[today] = {
                    status: 'success',
                    cravingCount: 0,
                    notes: ''
                };
                saveData();
            }
        }

        // マイルストーンの更新
        function updateMilestones(currentMinutes) {
            const milestonesContainer = document.getElementById('milestones');
            milestonesContainer.innerHTML = '';

            let nextMilestoneFound = false;

            healthMilestones.forEach(milestone => {
                const div = document.createElement('div');
                div.className = 'milestone';

                let statusText = '';
                let statusClass = '';
                let remainingText = '';

                if (currentMinutes >= milestone.minutes) {
                    div.classList.add('achieved');
                    statusText = '達成済み ✓';
                    statusClass = 'milestone-status';
                } else if (!nextMilestoneFound) {
                    div.classList.add('next');
                    statusText = '次の目標 →';
                    statusClass = 'milestone-status';
                    nextMilestoneFound = true;

                    // 残り時間を計算
                    const remainingMinutes = milestone.minutes - currentMinutes;
                    remainingText = `<div class="milestone-remaining">あと ${formatRemainingTime(remainingMinutes)}</div>`;
                } else {
                    div.classList.add('upcoming');
                    statusText = '未達成';
                    statusClass = 'milestone-status';

                    // 残り時間を計算
                    const remainingMinutes = milestone.minutes - currentMinutes;
                    remainingText = `<div class="milestone-remaining">あと ${formatRemainingTime(remainingMinutes)}</div>`;
                }

                const timeText = formatMilestoneTime(milestone.minutes);

                div.innerHTML = `
                    <span class="milestone-icon">${milestone.icon}</span>
                    <div class="${statusClass}">${statusText}</div>
                    <div class="milestone-time">${timeText}</div>
                    <div class="milestone-benefit">${milestone.text}</div>
                    ${remainingText}
                `;

                milestonesContainer.appendChild(div);
            });
        }

        // 残り時間のフォーマット
        function formatRemainingTime(minutes) {
            if (minutes < 60) {
                return `${minutes}分`;
            } else if (minutes < 1440) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return mins > 0 ? `${hours}時間${mins}分` : `${hours}時間`;
            } else if (minutes < 43200) {
                const days = Math.floor(minutes / 1440);
                const hours = Math.floor((minutes % 1440) / 60);
                return hours > 0 ? `${days}日${hours}時間` : `${days}日`;
            } else if (minutes < 525600) {
                const months = Math.floor(minutes / 43200);
                const days = Math.floor((minutes % 43200) / 1440);
                return days > 0 ? `${months}ヶ月${days}日` : `${months}ヶ月`;
            } else {
                const years = Math.floor(minutes / 525600);
                const months = Math.floor((minutes % 525600) / 43200);
                return months > 0 ? `${years}年${months}ヶ月` : `${years}年`;
            }
        }

        // マイルストーン時間のフォーマット
        function formatMilestoneTime(minutes) {
            if (minutes < 60) {
                return `${minutes}分`;
            } else if (minutes < 1440) {
                return `${Math.floor(minutes / 60)}時間`;
            } else if (minutes < 43200) {
                return `${Math.floor(minutes / 1440)}日`;
            } else if (minutes < 525600) {
                return `${Math.floor(minutes / 43200)}ヶ月`;
            } else {
                return `${Math.floor(minutes / 525600)}年`;
            }
        }

        // バッジの更新
        function updateBadges(currentMinutes, moneySaved) {
            const badgesContainer = document.getElementById('badges');
            badgesContainer.innerHTML = '';

            achievements.forEach(achievement => {
                const div = document.createElement('div');
                div.className = 'badge';

                let earned = false;
                if (achievement.condition === 'money') {
                    earned = moneySaved >= achievement.threshold;
                } else {
                    earned = currentMinutes >= achievement.minutes;
                }

                if (earned) {
                    div.classList.add('earned');
                }

                div.innerHTML = `
                    <div class="badge-icon">${achievement.icon}</div>
                    <div class="badge-name">${achievement.name}</div>
                `;

                badgesContainer.appendChild(div);
            });
        }

        // 進捗バーの更新
        function updateProgress(currentMinutes) {
            // 1週間（10080分）
            const week1Percent = Math.min(100, Math.floor((currentMinutes / 10080) * 100));
            document.getElementById('week1Progress').textContent = `${week1Percent}%`;
            document.getElementById('week1Bar').style.width = `${week1Percent}%`;
            document.getElementById('week1Bar').textContent = week1Percent > 0 ? `${week1Percent}%` : '';

            // 1ヶ月（43200分）
            const month1Percent = Math.min(100, Math.floor((currentMinutes / 43200) * 100));
            document.getElementById('month1Progress').textContent = `${month1Percent}%`;
            document.getElementById('month1Bar').style.width = `${month1Percent}%`;
            document.getElementById('month1Bar').textContent = month1Percent > 0 ? `${month1Percent}%` : '';

            // 1年（525600分）
            const year1Percent = Math.min(100, Math.floor((currentMinutes / 525600) * 100));
            document.getElementById('year1Progress').textContent = `${year1Percent}%`;
            document.getElementById('year1Bar').style.width = `${year1Percent}%`;
            document.getElementById('year1Bar').textContent = year1Percent > 0 ? `${year1Percent}%` : '';
        }
    </script>
</body>
</html>
